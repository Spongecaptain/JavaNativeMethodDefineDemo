# 实现 JNI

## 1. JNI的生成步骤

1. 编写带有 native 声明的方法的 java 类，生成 .java 文件；
2. 使用 javac 命令编译所编写的 java 类，生成 .class 文件；
3. 使用 javah -jni java 类名生成扩展名为 h 的头文件，也即生成 .h 文件
4. 使用 C/C++（或者其他编程想语言）实现本地方法，创建 .h 文件的实现，也就是创建 .cpp 文件实现 .h 文件中的方法；
5. 将 C/C++ 编写的文件生成动态连接库（不同操作系统对应的库有所不同）；

## 2. JNI 实现案例

> 注意：所有命令的工作目录都为 Java 源码同级目录。

**1.编写带有 native 声明的 java 类，HelloWorld.java**

```java
public class HelloWorld {
    public native void sayHelloWorld(); //申明一个native方法

    static{
        System.loadLibrary("HelloWorldImpl"); //装入动态链接库,"HelloWorldImpl"是装入动态链接库的名称
    }

    public static void main(String[] args){
        HelloWorld helloWorld = new HelloWorld();
        helloWorld.sayHelloWorld();
    }
}
```

动态库在不同操作系统下有着不同的意义：

- Windows             HelloNative.dll
- Linux               libHelloWorldImpl.so
- Mac                 libHelloWorldImpl.jnilib

知道名字关系很重要，因为将影响步骤 5 中的命名参数。

**2.使用 javac 生成 HelloWorld.class** 

```bash
javac HelloWorld.java
```

**3.使用 javah -jni java 类生成扩展名为 h 的头文件**

> **此处需要注意的是，我们应该在包名的根目录下执行，因为生成的文件的文件名需要引用包目录。不然就会报找不到类文件的错误**

```bash
javah -jni HelloWorld
```

注意事项：至少是从 JDK10 开始（我本机安装 JDK11），已经使用 javac -h 来代替 javah，因此这个时候应当使用如命令来代替此命令：

```bash
javac HelloWorld.java -h .
```

> 其中 `.` 用于定义头文件产生的目录。

于是乎，在当前路径下的自动生成了 HelloWorld.h 文件，如下所示：

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class HelloWorld */

#ifndef _Included_HelloWorld
#define _Included_HelloWorld
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     HelloWorld
 * Method:    sayHelloWorld
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_HelloWorld_sayHelloWorld
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```
**4.使用C/C++实现本地方法**

创建 HelloWorldImpl.cpp，代码如下所示：

> 注意确保与头文件中的引用保持一致。

```c++
#include "jni.h"
#include "HelloWorld.h"
#include <stdio.h>
JNIEXPORT void JNICALL Java_HelloWorld_sayHelloWorld(JNIEnv *env,jobject obj){
    printf("Hello World! Spongecaptain~~~\n");
    return;
}
```

**5.将本地方法编写的文件生成动态链接库**

运行如下命令：

```
gcc -I/Library/Java/JavaVirtualMachines/adoptopenjdk-11.jdk/Contents/Home/include/ -I/Library/Java/JavaVirtualMachines/adoptopenjdk-11.jdk/Contents/Home/include/darwin/ -dynamiclib HelloWorldImpl.cpp -o libHelloWorldImpl.jnilib
```

注意：libHelloWorldImpl.jnilib 参数的后缀取决于操作系统，名称取决于 Java 源码中 System#loadLibrary 方法的入口参数。

其中，JDK 目录可以利用如下命令得到：

```bash
echo $JAVA_HOME
```

**6.测试运行**

```bash
java HelloWorld
```

测试结果：

```
Hello World! Spongecaptain~~~
```

